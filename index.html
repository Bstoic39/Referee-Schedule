<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="theme-color" content="#111827" />
  <title>Referee Schedule</title>

  <link rel="manifest" href="site.webmanifest" />
  <link rel="apple-touch-icon" href="apple-touch-icon.png" />
  <link rel="icon" href="favicon.ico" />

  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-white">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>

  <script>
    const { useEffect, useMemo, useRef, useState } = React;

    // ---------- Date helpers ----------
    function pad2(n) { return String(n).padStart(2, '0'); }
    function toLocalDateKey(d) {
      return `${d.getFullYear()}-${pad2(d.getMonth() + 1)}-${pad2(d.getDate())}`;
    }
    function monthKeyFromDateKey(dateKey) { return dateKey.slice(0, 7); } // YYYY-MM

    function parseGameDateTime(game) {
      const [y, m, d] = game.date.split('-').map(Number);
      let hh = 0, mm = 0;
      if (game.time && /^\d{2}:\d{2}$/.test(game.time)) [hh, mm] = game.time.split(':').map(Number);
      return new Date(y, m - 1, d, hh, mm, 0, 0);
    }

    function formatNiceDate(dateKey) {
      const [y, m, d] = dateKey.split('-').map(Number);
      return new Date(y, m - 1, d).toLocaleDateString();
    }

    function formatNiceMonth(monthKey) {
      const [y, m] = monthKey.split('-').map(Number);
      return new Date(y, m - 1, 1).toLocaleDateString(undefined, { year: 'numeric', month: 'long' });
    }

    function startOfMonth(dateObj) { return new Date(dateObj.getFullYear(), dateObj.getMonth(), 1); }

    function getMonthGrid(dateObj) {
      const first = startOfMonth(dateObj);
      const firstDay = first.getDay(); // 0 Sun .. 6 Sat
      const gridStart = new Date(first);
      gridStart.setDate(first.getDate() - firstDay);

      const cells = [];
      for (let i = 0; i < 42; i++) {
        const d = new Date(gridStart);
        d.setDate(gridStart.getDate() + i);
        cells.push({ date: d, inMonth: d.getMonth() === dateObj.getMonth() });
      }
      return cells;
    }

    // ---------- Storage keys ----------
    const STORAGE_ACTIVE   = 'refGames_v4_active';
    const STORAGE_ARCHIVE  = 'refGames_v4_archive';  // { "YYYY-MM": [games...] }
    const STORAGE_SETTINGS = 'refGames_v4_settings'; // { notificationsEnabled: boolean }

    function RefereeScheduleApp() {
      const [view, setView] = useState('list'); // list | calendar | archive
      const [activeGames, setActiveGames] = useState([]);
      const [archiveByMonth, setArchiveByMonth] = useState({});
      const [showForm, setShowForm] = useState(false);

      const [calendarCursor, setCalendarCursor] = useState(() => new Date());
      const [selectedDateKey, setSelectedDateKey] = useState(null);

      const [notificationsEnabled, setNotificationsEnabled] = useState(false);
      const swRegRef = useRef(null);
      const scheduledTimeoutsRef = useRef([]);

      const [formData, setFormData] = useState({
        league: '',
        date: '',
        time: '',
        facility: '',
        partner: '',
        numGames: 1,
        rate: ''
      });

      // ----- Service worker registration (NO caching; notifications only) -----
      useEffect(() => {
        (async () => {
          if (!('serviceWorker' in navigator)) return;
          try {
            await navigator.serviceWorker.register('./service-worker.js', { scope: './' });
            const reg = await navigator.serviceWorker.ready;
            swRegRef.current = reg;
          } catch (e) {
            console.warn('Service worker registration failed:', e);
          }
        })();
      }, []);

      // ----- Load from storage -----
      useEffect(() => {
        try {
          const savedActive = localStorage.getItem(STORAGE_ACTIVE);
          const savedArchive = localStorage.getItem(STORAGE_ARCHIVE);
          const savedSettings = localStorage.getItem(STORAGE_SETTINGS);

          if (savedActive) setActiveGames(JSON.parse(savedActive));
          if (savedArchive) setArchiveByMonth(JSON.parse(savedArchive));
          if (savedSettings) setNotificationsEnabled(Boolean(JSON.parse(savedSettings).notificationsEnabled));
        } catch (e) {
          console.warn('Failed to load storage', e);
        }
      }, []);

      // ----- Persist -----
      useEffect(() => { try { localStorage.setItem(STORAGE_ACTIVE, JSON.stringify(activeGames)); } catch {} }, [activeGames]);
      useEffect(() => { try { localStorage.setItem(STORAGE_ARCHIVE, JSON.stringify(archiveByMonth)); } catch {} }, [archiveByMonth]);
      useEffect(() => { try { localStorage.setItem(STORAGE_SETTINGS, JSON.stringify({ notificationsEnabled })); } catch {} }, [notificationsEnabled]);

      // ----- Auto-archive past games -----
      useEffect(() => {
        const run = () => {
          const now = new Date();
          const toArchive = [];
          const stillActive = [];

          for (const g of activeGames) {
            const dt = parseGameDateTime(g);
            if (dt.getTime() < now.getTime()) toArchive.push(g);
            else stillActive.push(g);
          }
          if (toArchive.length === 0) return;

          setActiveGames(stillActive);

          setArchiveByMonth(prev => {
            const next = { ...prev };
            for (const g of toArchive) {
              const mk = monthKeyFromDateKey(g.date);
              next[mk] = (next[mk] || []).concat([g]);
              next[mk].sort((a, b) => parseGameDateTime(a) - parseGameDateTime(b));
            }
            return next;
          });
        };

        if (activeGames.length) run();
        const id = setInterval(run, 60 * 1000);
        return () => clearInterval(id);
      }, [activeGames]);

      // ----- Notification helpers (via SW showNotification) -----
      function clearScheduledTimeouts() {
        for (const id of scheduledTimeoutsRef.current) clearTimeout(id);
        scheduledTimeoutsRef.current = [];
      }

      async function showReminderNotification(game) {
        const reg = swRegRef.current || (await navigator.serviceWorker?.ready?.catch(() => null));
        if (!reg || !reg.showNotification) return;

        const title = 'Referee game in 2 hours';
        const when = `${formatNiceDate(game.date)}${game.time ? ` @ ${game.time}` : ''}`;
        const bodyParts = [game.league, when];
        if (game.facility) bodyParts.push(game.facility);
        const body = bodyParts.filter(Boolean).join(' â€¢ ');

        await reg.showNotification(title, {
          body,
          tag: `game-${game.id}`,
          renotify: false
        });
      }

      function scheduleNotifications() {
        clearScheduledTimeouts();
        if (!notificationsEnabled) return;
        if (!('Notification' in window)) return;

        const now = Date.now();
        const TWO_HOURS = 2 * 60 * 60 * 1000;

        for (const g of activeGames) {
          const gameDt = parseGameDateTime(g).getTime();
          const fireAt = gameDt - TWO_HOURS;
          if (fireAt <= now) continue;

          const delay = fireAt - now;

          // cap very long timeouts; we'll rescan every minute
          const SEVEN_DAYS = 7 * 24 * 60 * 60 * 1000;
          if (delay > SEVEN_DAYS) continue;

          const id = setTimeout(() => {
            if (Notification.permission === 'granted') {
              showReminderNotification(g).catch(e => console.warn('showNotification failed', e));
            }
          }, delay);

          scheduledTimeoutsRef.current.push(id);
        }
      }

      useEffect(() => {
        scheduleNotifications();
        const id = setInterval(scheduleNotifications, 60 * 1000);
        return () => {
          clearInterval(id);
          clearScheduledTimeouts();
        };
      }, [activeGames, notificationsEnabled]);

      async function enableNotifications() {
        if (!('Notification' in window)) {
          alert('Notifications are not supported in this browser.');
          return;
        }

        // already granted
        if (Notification.permission === 'granted') {
          setNotificationsEnabled(true);
          return;
        }

        let perm;
        try {
          perm = await Notification.requestPermission();
        } catch (e) {
          alert('Notification permission prompt failed.');
          return;
        }

        if (perm !== 'granted') {
          alert('Notification permission was not granted.');
          setNotificationsEnabled(false);
          return;
        }

        setNotificationsEnabled(true);

        // Optional test via SW (non-fatal if it fails)
        try {
          const reg = swRegRef.current || (await navigator.serviceWorker.ready);
          await reg.showNotification('Notifications enabled', {
            body: 'Reminders will trigger 2 hours before games while the app is open.'
          });
        } catch (e) {
          console.log('Test notification failed (non-fatal):', e);
        }
      }

      function disableNotifications() {
        setNotificationsEnabled(false);
        clearScheduledTimeouts();
      }

      // ----- CRUD -----
      function addGame() {
        if (!formData.league || !formData.date) return;

        const numGames = Number(formData.numGames) || 1;
        const rate = Number(formData.rate) || 0;

        const newGame = {
          id: Date.now(),
          league: formData.league.trim(),
          date: formData.date,
          time: formData.time,
          facility: formData.facility.trim(),
          partner: formData.partner.trim(),
          numGames,
          rate,
          total: numGames * rate
        };

        setActiveGames(prev =>
          [...prev, newGame].sort((a, b) => parseGameDateTime(a) - parseGameDateTime(b))
        );

        setFormData({
          league: '',
          date: '',
          time: '',
          facility: '',
          partner: '',
          numGames: 1,
          rate: ''
        });

        setShowForm(false);
      }

      function deleteActive(id) { setActiveGames(prev => prev.filter(g => g.id !== id)); }

      function deleteArchived(monthKey, id) {
        setArchiveByMonth(prev => {
          const next = { ...prev };
          next[monthKey] = (next[monthKey] || []).filter(g => g.id !== id);
          if (next[monthKey].length === 0) delete next[monthKey];
          return next;
        });
      }

      // ----- Derived maps -----
      const totalEarningsActive = useMemo(() => (
        activeGames.reduce((sum, g) => sum + (Number(g.total) || 0), 0)
      ), [activeGames]);

      const gamesByDateKey = useMemo(() => {
        const map = {};
        for (const g of activeGames) {
          map[g.date] = map[g.date] || [];
          map[g.date].push(g);
        }
        for (const k of Object.keys(map)) map[k].sort((a, b) => parseGameDateTime(a) - parseGameDateTime(b));
        return map;
      }, [activeGames]);

      const archivedGamesByDateKey = useMemo(() => {
        const map = {};
        for (const mk of Object.keys(archiveByMonth)) {
          for (const g of (archiveByMonth[mk] || [])) {
            map[g.date] = map[g.date] || [];
            map[g.date].push(g);
          }
        }
        for (const k of Object.keys(map)) map[k].sort((a, b) => parseGameDateTime(a) - parseGameDateTime(b));
        return map;
      }, [archiveByMonth]);

      const selectedActiveGames = useMemo(() => (
        selectedDateKey ? (gamesByDateKey[selectedDateKey] || []) : []
      ), [gamesByDateKey, selectedDateKey]);

      const selectedArchivedGames = useMemo(() => (
        selectedDateKey ? (archivedGamesByDateKey[selectedDateKey] || []) : []
      ), [archivedGamesByDateKey, selectedDateKey]);

      // ---------- UI helpers ----------
      const inputClass =
        "w-full mb-2 p-2 bg-gray-700 rounded outline-none focus:ring-2 focus:ring-blue-500";

      function TabButton({ id, label }) {
        const active = view === id;
        return React.createElement(
          'button',
          {
            onClick: () => {
              setView(id);
              if (id !== 'calendar') setSelectedDateKey(null);
            },
            className:
              (active ? 'bg-blue-600 text-white' : 'bg-gray-800 text-gray-200 hover:bg-gray-700') +
              ' px-3 py-2 rounded-lg text-sm font-semibold'
          },
          label
        );
      }

      function GameCard({ game, onDelete }) {
        return React.createElement(
          'div',
          { className: 'bg-gray-800 p-4 rounded-lg mb-3' },
          React.createElement('div', { className: 'font-semibold text-lg' }, game.league),
          React.createElement(
            'div',
            { className: 'text-sm text-gray-400 mb-2' },
            formatNiceDate(game.date) + (game.time ? ` @ ${game.time}` : '')
          ),
          (game.facility || game.partner)
            ? React.createElement(
                'div',
                { className: 'text-sm text-gray-300 mb-2' },
                (game.facility ? `ðŸ“ ${game.facility}` : '') +
                (game.facility && game.partner ? ' â€¢ ' : '') +
                (game.partner ? `ðŸ¤ ${game.partner}` : '')
              )
            : null,
          React.createElement(
            'div',
            { className: 'flex justify-between text-sm items-center' },
            React.createElement('span', null, `${game.numGames} game(s) @ $${game.rate}`),
            React.createElement('span', { className: 'text-green-400 font-semibold' }, `$${game.total}`)
          ),
          React.createElement(
            'button',
            { onClick: onDelete, className: 'mt-3 text-red-300 hover:text-red-200 text-sm' },
            'Delete'
          )
        );
      }

      function ListView() {
        return React.createElement(
          React.Fragment,
          null,
          React.createElement(
            'div',
            { className: 'bg-gray-800 p-4 rounded-lg mb-4 flex items-center justify-between gap-3' },
            React.createElement(
              'div',
              null,
              React.createElement('div', { className: 'text-sm text-gray-400' }, 'Active Earnings'),
              React.createElement('div', { className: 'text-xl font-bold text-green-400' }, `$${totalEarningsActive}`)
            ),
            React.createElement(
              'div',
              { className: 'flex flex-col items-end gap-2' },
              notificationsEnabled
                ? React.createElement(
                    'button',
                    { className: 'text-xs bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded', onClick: disableNotifications },
                    'Notifications: ON'
                  )
                : React.createElement(
                    'button',
                    { className: 'text-xs bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded', onClick: enableNotifications },
                    'Enable notifications'
                  ),
              React.createElement(
                'div',
                { className: 'text-[11px] text-gray-400 text-right leading-snug max-w-[220px]' },
                'SW notifications are more reliable on Android. Still requires app open for timers.'
              )
            )
          ),

          activeGames.length === 0
            ? React.createElement('div', { className: 'text-center text-gray-400 py-10' }, 'No games scheduled')
            : activeGames.map(g =>
                React.createElement(GameCard, { key: g.id, game: g, onDelete: () => deleteActive(g.id) })
              )
        );
      }

      function CalendarDaySheet() {
        if (!selectedDateKey) return null;

        const hasAny = selectedActiveGames.length > 0 || selectedArchivedGames.length > 0;

        return React.createElement(
          'div',
          { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-end', onClick: () => setSelectedDateKey(null) },
          React.createElement(
            'div',
            {
              className: 'bg-gray-800 w-full p-6 rounded-t-2xl max-h-[75vh] overflow-y-auto',
              onClick: (e) => e.stopPropagation()
            },
            React.createElement(
              'div',
              { className: 'flex items-center justify-between mb-3' },
              React.createElement('div', { className: 'text-lg font-semibold' }, formatNiceDate(selectedDateKey)),
              React.createElement(
                'button',
                { className: 'text-sm bg-gray-700 hover:bg-gray-600 px-3 py-2 rounded', onClick: () => setSelectedDateKey(null) },
                'Close'
              )
            ),

            !hasAny
              ? React.createElement('div', { className: 'text-center text-gray-400 py-6' }, 'No games on this day.')
              : React.createElement(
                  React.Fragment,
                  null,

                  selectedActiveGames.length > 0
                    ? React.createElement(
                        React.Fragment,
                        null,
                        React.createElement('div', { className: 'text-sm text-gray-300 mb-2' }, 'Active'),
                        selectedActiveGames.map(g =>
                          React.createElement(GameCard, { key: g.id, game: g, onDelete: () => deleteActive(g.id) })
                        )
                      )
                    : null,

                  selectedArchivedGames.length > 0
                    ? React.createElement(
                        React.Fragment,
                        null,
                        React.createElement('div', { className: 'text-sm text-gray-300 mt-4 mb-2' }, 'Archived'),
                        selectedArchivedGames.map(g =>
                          React.createElement(GameCard, {
                            key: g.id,
                            game: g,
                            onDelete: () => deleteArchived(monthKeyFromDateKey(g.date), g.id)
                          })
                        )
                      )
                    : null
                )
          )
        );
      }

      function CalendarView() {
        const cells = getMonthGrid(calendarCursor);
        const monthLabel = calendarCursor.toLocaleDateString(undefined, { month: 'long', year: 'numeric' });
        const todayKey = toLocalDateKey(new Date());

        function prevMonth() { setCalendarCursor(d => new Date(d.getFullYear(), d.getMonth() - 1, 1)); }
        function nextMonth() { setCalendarCursor(d => new Date(d.getFullYear(), d.getMonth() + 1, 1)); }

        const weekDays = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];

        return React.createElement(
          'div',
          null,
          React.createElement(
            'div',
            { className: 'flex items-center justify-between mb-3' },
            React.createElement('button', { className: 'bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded', onClick: prevMonth }, 'â€¹'),
            React.createElement('div', { className: 'font-semibold' }, monthLabel),
            React.createElement('button', { className: 'bg-gray-800 hover:bg-gray-700 px-3 py-2 rounded', onClick: nextMonth }, 'â€º')
          ),
          React.createElement(
            'div',
            { className: 'grid grid-cols-7 gap-1 mb-1 text-xs text-gray-400' },
            weekDays.map(w => React.createElement('div', { key: w, className: 'text-center py-1' }, w))
          ),
          React.createElement(
            'div',
            { className: 'grid grid-cols-7 gap-1' },
            cells.map((cell, idx) => {
              const dk = toLocalDateKey(cell.date);
              const dayNum = cell.date.getDate();
              const items = gamesByDateKey[dk] || [];
              const isToday = dk === todayKey;

              return React.createElement(
                'button',
                {
                  key: idx,
                  onClick: () => setSelectedDateKey(dk),
                  className:
                    (cell.inMonth ? 'bg-gray-800' : 'bg-gray-950') +
                    ' rounded p-2 min-h-[72px] text-left border ' +
                    (isToday ? 'border-blue-500' : 'border-transparent') +
                    ' hover:bg-gray-700 active:scale-[0.99] transition'
                },
                React.createElement(
                  'div',
                  { className: (cell.inMonth ? 'text-gray-200' : 'text-gray-600') + ' text-xs mb-1' },
                  dayNum
                ),
                items.slice(0, 2).map(g =>
                  React.createElement(
                    'div',
                    { key: g.id, className: 'text-[11px] bg-gray-700 rounded px-1 py-0.5 mb-1 truncate' },
                    (g.time ? `${g.time} ` : '') + g.league
                  )
                ),
                items.length > 2
                  ? React.createElement('div', { className: 'text-[11px] text-gray-400' }, `+${items.length - 2} more`)
                  : null
              );
            })
          ),
          React.createElement(CalendarDaySheet)
        );
      }

      function ArchiveView() {
        const monthKeys = Object.keys(archiveByMonth).sort().reverse();
        return React.createElement(
          'div',
          null,
          monthKeys.length === 0
            ? React.createElement('div', { className: 'text-center text-gray-400 py-10' }, 'Archive is empty (past games auto-move here).')
            : monthKeys.map(mk => {
                const games = archiveByMonth[mk] || [];
                const monthTotal = games.reduce((s, g) => s + (Number(g.total) || 0), 0);
                return React.createElement(
                  'div',
                  { key: mk, className: 'mb-6' },
                  React.createElement(
                    'div',
                    { className: 'flex items-baseline justify-between mb-2' },
                    React.createElement('div', { className: 'font-semibold text-lg' }, formatNiceMonth(mk)),
                    React.createElement('div', { className: 'text-green-400 font-semibold' }, `$${monthTotal}`)
                  ),
                  games.map(g =>
                    React.createElement(GameCard, {
                      key: g.id,
                      game: g,
                      onDelete: () => deleteArchived(mk, g.id)
                    })
                  )
                );
              })
        );
      }

      // ----- Main render -----
      return React.createElement(
        'div',
        { className: 'min-h-screen p-4 max-w-md mx-auto' },

        React.createElement('h1', { className: 'text-2xl font-bold mb-4 text-center' }, 'Referee Schedule'),

        React.createElement(
          'div',
          { className: 'flex gap-2 justify-center mb-4' },
          React.createElement(TabButton, { id: 'list', label: 'List' }),
          React.createElement(TabButton, { id: 'calendar', label: 'Calendar' }),
          React.createElement(TabButton, { id: 'archive', label: 'Archive' })
        ),

        view === 'list'
          ? React.createElement(ListView)
          : view === 'calendar'
            ? React.createElement(CalendarView)
            : React.createElement(ArchiveView),

        view === 'list' &&
          React.createElement(
            'button',
            {
              onClick: () => setShowForm(true),
              className: 'fixed bottom-6 right-6 bg-blue-600 hover:bg-blue-500 p-4 rounded-full shadow-lg text-2xl leading-none'
            },
            '+'
          ),

        showForm &&
          React.createElement(
            'div',
            { className: 'fixed inset-0 bg-black bg-opacity-50 flex items-end' },
            React.createElement(
              'div',
              { className: 'bg-gray-800 w-full p-6 rounded-t-2xl' },

              React.createElement('h2', { className: 'text-xl font-bold mb-4' }, 'Add Game'),

              React.createElement('input', {
                placeholder: 'League *',
                className: inputClass,
                value: formData.league,
                onChange: e => setFormData({ ...formData, league: e.target.value })
              }),

              React.createElement('input', {
                type: 'date',
                className: inputClass,
                value: formData.date,
                onChange: e => setFormData({ ...formData, date: e.target.value })
              }),

              React.createElement('input', {
                type: 'time',
                className: inputClass,
                value: formData.time,
                onChange: e => setFormData({ ...formData, time: e.target.value })
              }),

              React.createElement('input', {
                placeholder: 'Facility',
                className: inputClass,
                value: formData.facility,
                onChange: e => setFormData({ ...formData, facility: e.target.value })
              }),

              React.createElement('input', {
                placeholder: 'Partner',
                className: inputClass,
                value: formData.partner,
                onChange: e => setFormData({ ...formData, partner: e.target.value })
              }),

              React.createElement('input', {
                type: 'number',
                min: 1,
                placeholder: 'Number of games',
                className: inputClass,
                value: formData.numGames,
                onChange: e => setFormData({ ...formData, numGames: e.target.value })
              }),

              React.createElement('input', {
                type: 'number',
                min: 0,
                step: '0.01',
                placeholder: 'Rate (per game)',
                className: inputClass,
                value: formData.rate,
                onChange: e => setFormData({ ...formData, rate: e.target.value })
              }),

              React.createElement(
                'div',
                { className: 'flex gap-2 mt-2' },
                React.createElement(
                  'button',
                  { className: 'flex-1 bg-gray-600 hover:bg-gray-500 p-2 rounded', onClick: () => setShowForm(false) },
                  'Cancel'
                ),
                React.createElement(
                  'button',
                  { className: 'flex-1 bg-blue-600 hover:bg-blue-500 p-2 rounded', onClick: addGame },
                  'Add'
                )
              )
            )
          )
      );
    }

    ReactDOM.render(
      React.createElement(RefereeScheduleApp),
      document.getElementById('root')
    );
  </script>
</body>
</html>
